- （はじめに）
	- `fcntl()`
	- カーネル内部データ
	- オフセットを変更しないIO,複数バッファを一度に処理するIO,ノンブロッキングIO,large size file等
	- テンポラリファイルはランダムかつ一意なファイル名を生成する
- 5.1 アトミック動作と競合状態 ^d8e3d3
	- システムコールの動作を議論する上でアトミックという概念は避けて通れない
	- 処理内容によってアトミックが必須の場合がある
		-  アトミックで競合状態を防げる
		- 競合状態(race condition, race hazard)とは
			- 同じリソースを共有
			- 操作する２プロセス（またはスレッド）がCPU上で任意の順序で実行された結果として発生する問題
	- 競合状態が発生するファイルIOの２例を挙げる
	- その他の競合状態について
		- [[22章 シグナル：応用#^743c8a|22.9 シグナルマスクとシグナル待ち合わせ：sigsuspend()]]
		- [[24章 プロセス作成#^592f2f|24.4 fork()後の競合状態]]
	- 1.ファイルの排他的作成
		- 1.`open()`を一度行ってファイルの存在をチェック、
			- この間に別プロセスが同じファイルを作成してしまう可能性がある
		- 2.存在しなければ再度`open()`を行いファイル作成
	- 2.同一ファイルへの複数プロセスの書き込み
		- 1.`lseek()`
		- 2.`write()`
		- 二つめのプロセスが最後の部分の内容を上書きしてしまう
	- ファイルオフセット移動と書き込み処理をアトミックに実行したい
		- ->`O_APPEND`
		- NFSなど一部ファイルシステムは`O_APPEND`に対応していない
			- カーネル内でファイル破壊を防止しつつ非アトミックな手順へ変換している
	

- 5.3 オープンファイルステータスフラグ ^c47b87

- 5.4 ファイルディスクリプタとオープンしたファイルの関係 ^c9e83c
	- 3種類のカーネルデータ
		- ファイルディスクリプタテーブル
			- プロセスごとに存在
		- オープンファイル（情報）テーブル
			- プロセス単位ではないシステム全体を網羅
		- i-nodeテーブル
			- ファイルシステムのテーブル
	- ファイルディスクリプタテーブル
		- `close-on-exec`とファイル情報へのポインタのみ
	- オープンファイル（情報）テーブル
		- ファイルオフセットの現在位置
			- `read(),write()`による自動更新、`lseek()`で明示的移動可能
		- オープン時に指定されたファイルステータスフラグ
		- ファイルアクセスモード
		- [[63章 高度なIOモデル#^7a9dbe|シグナルドリブンIO]]情報
		- i-nodeへのポインタ
			- 簡単にi-nodeに含まれるもの
				- ファイル種類（通常ファイル、ソケット、FIFO）
				- ロック情報リストへのポインタ
				- ファイルサイズ、タイムスタンプ等属性
	- ![[Pasted image 20240314112228.png]]
	- ３つのパターン
		- A-fd1,fd20は同一オープンファイル情報を参照してる
			- `dup(),dup2(),fcntl()`
		- A-fd2,B-fd3も同一オープンファイル情報を参照してる
			- `fork()`,ソケットを使うIPCでfdを送受信しても作られる([[61章 ソケット：応用#^56af04|61.13.3]])
		- A-fd0,B-fd3は異なるオープンファイル情報だが同一i-nodeテーブルでは同じ同一ファイルを参照してる
			- 同じファイルを
				- 別プロセスで個別に`open()`してる
				- 同一プロセスで複数回`open()`してる
	- 考察
		- オープンファイル情報が同じなら`read(),write(),lseek()`の実行後、ファイルオフセットは移動すると、もう一方のfdからも移動する
		- ファイルディスクリプタのフラグ(close-on-exec)はfdおよびプロセス固有の情報でこのフラグは他のfdに影響しない


- 5.9 ノンブロッキングIO ^944e01
	- ファイルをすぐにオープンできない時に即時エラーを返す
		- openがブロックする例としてFIFOがある
	- オープンした後もブロックはしない
	- デバイス、パイプ、FIFO、ソケットに対して使用可能
		- パイプ、ソケットは`fcntl()`の`F_SETFL`を実行する
	- [[44章 パイプとFIFO#^a116a5|44.9 ノンブロッキングI/O]],63章でも詳細に解説する

- 5.10 large fileのIO ^e60d69